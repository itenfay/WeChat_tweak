## WeChat_tweak

iOSç‰ˆåŠŸèƒ½æœ€å…¨çš„å¾®ä¿¡æ’ä»¶ï¼Œæ”¯æŒæœ€æ–°ç‰ˆå¾®ä¿¡ï¼Œå…·å¤‡è‡ªåŠ¨æŠ¢çº¢åŒ…ï¼Œå±è”½æ¶ˆæ¯å’Œç¾¤æ¶ˆæ¯ï¼Œè¿‡æ»¤ç‰¹å®šçš„ç¾¤èŠï¼Œé˜²æ­¢æ’¤å›æ¶ˆæ¯ï¼Œä¼ªå®šä½ (æœ‹å‹åœˆå’Œé™„è¿‘çš„äºº)ï¼Œä¿®æ”¹å¾®ä¿¡è¿åŠ¨æ­¥æ•°å’Œå®æ—¶å–æ™¯åšä¿¡æ¯å†…å®¹é¡µçš„èŠå¤©èƒŒæ™¯ç­‰åŠŸèƒ½ã€‚

[![License MIT](https://img.shields.io/badge/license-MIT-green.svg?style=flat)](LICENSE)&nbsp;

## æ’ä»¶ç‰¹ç‚¹

i. åŸç”Ÿä½“éªŒ

æ’ä»¶ UI å®Œç¾åµŒå…¥å¾®ä¿¡è®¾ç½®ä¸­ï¼Œå¼€å¯å„åŠŸèƒ½åï¼Œæ‰€æœ‰æ‰§è¡Œçš„ä»»åŠ¡éƒ½ä¼šé™é»˜è¿›è¡Œï¼Œä¸å¹²æ‰°å¾®ä¿¡çš„æ­£å¸¸ä½¿ç”¨ã€‚

ii. è‡ªç”±è®¾ç½®å»¶è¿ŸæŠ¢çº¢åŒ…æ—¶é—´

æœ‰æ•ˆé˜²æ­¢æŠ¢çº¢åŒ…é€Ÿåº¦å¤ªå¿«è€Œè¢«æ‹‰é»‘æˆ–è¸¢å‡ºç¾¤èŠã€‚

iii. è®¾ç½®é˜²æ­¢åŒæ—¶æŠ¢å¤šä¸ªçº¢åŒ…

æœ€å¤§ç¨‹åº¦é¿å…è¢«ç³»ç»Ÿæ£€æµ‹å‡ºä½¿ç”¨æ’ä»¶ï¼Œçº¢åŒ…æŠ¢å¾—æ›´å®‰å¿ƒã€‚

iv. è®¾ç½®è¿‡æ»¤ç‰¹å®šçš„ç¾¤èŠ

é˜²æ­¢è½å…¥å®¶äººå¥½å‹ç¾¤ã€ç‚¹é¤ç¾¤æˆ–è€…å…¬å¸ç¾¤æŠ¢çº¢åŒ…çš„å°´å°¬å¢ƒåœ°ã€‚

v. ä¼ªå®šä½ 

è‡ªç”±ä¿®æ”¹æ‰‹æœºå®šä½ï¼Œå¶å°”å‡ºä¸ªå›½ï¼Œå‘ä¸ªæœ‹å‹åœˆï¼Œè£…ä¸ªé€¼ã€‚

vi. å±è”½æ¶ˆæ¯å’Œç¾¤æ¶ˆæ¯ï¼Œé˜²æ­¢æ’¤å›æ¶ˆæ¯

å±è”½è®¨åŒçš„äººå’Œç¾¤çš„æ¶ˆæ¯ï¼Œè®©ä»–ä»¬ä¸å†æ‰“æ‰°ä½ ï¼Œéœ€è¦æ—¶å¯å…³é—­ï¼Œé‡æ–°æ¥æ”¶ä»–ä»¬çš„æ¶ˆæ¯ï¼Œé˜²æ­¢æ’¤å›æ¶ˆæ¯ï¼Œè®©ä½ ä¸å†é”™è¿‡ä»»ä½•ä¿¡æ¯ã€‚

## å…è´£å£°æ˜

- æœ¬æ–‡æ‰€æœ‰çº¯å±ä¸ªäººå¨±ä¹å­¦ä¹ ç”¨ï¼Œç›¸å…³æŠ€æœ¯ä»…ç”¨äºå­¦ä¹ äº¤æµï¼Œè¯·å‹¿ç”¨äºéæ³•ç›®çš„ï¼Œä¸å¾—æœ‰å…¶ä»–ä»»ä½•å•†ä¸šç”¨é€”ï¼ï¼ï¼
- å¤–æŒ‚æœ‰é£é™©ï¼Œä½¿ç”¨éœ€è°¨æ…ã€‚
- å½“ä½¿ç”¨æœ¬æ’ä»¶æ—¶ï¼Œè¯·ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…å„ç§çŠ¶å†µï¼ŒåŒ…æ‹¬ä½†ä¸é™äºâ€œç¦ç”¨çº¢åŒ…åŠŸèƒ½â€ä»¥åŠâ€œå¾®ä¿¡å°å·â€ã€‚

## Group (ID:614799921)

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/g614799921.jpg" width="30%" />
</div>

## Preview

- æ’ä»¶è®¾ç½®

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/wcplugin_settings.png" width="30%" />&nbsp; 
<img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/wcplugin_xwtx1.png" width="30%" />&nbsp; 
<img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/wcplugin_xwtx2.png" width="30%" />
</div>

- è‡ªåŠ¨æŠ¢çº¢åŒ…

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/wcplugin_redenv.gif" width="30%" />
</div>

- å±è”½æ¶ˆæ¯

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/wcplugin_pbqxx.png" width="30%" />&nbsp; 
<img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/wcplugin_pbxx.png" width="30%" />
</div>

- ä¼ªå®šä½

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/fake_location.png" width="30%" />
</div>

- é˜²æ­¢æ’¤å›æ¶ˆæ¯

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/prevent_msg_revoc.png" width="30%" />
</div>

## åŸºæœ¬åŸç†

åœ¨ App å¯åŠ¨æ—¶ï¼Œé€šè¿‡ dyld (the dynamic link editor) åŠ è½½æˆ‘ä»¬æ³¨å…¥çš„åŠ¨æ€åº“ï¼Œä»è€Œè¿›è¡Œ hook ï¼Œè€Œä¹‹æ‰€ä»¥èƒ½å¤Ÿæ‰§è¡Œæ³¨å…¥çš„åŠ¨æ€åº“ï¼Œæ˜¯å› ä¸ºä½¿ç”¨äº† mobilesubstrate åº“ï¼Œè¿™ä¸ªåº“èƒ½åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™åŠ¨æ€åŠ è½½æ³¨å…¥çš„åŠ¨æ€åº“ï¼Œè€Œéè¶Šç‹±æ‰‹æœºé‡Œé¢æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç›´æ¥å°†è¿™ä¸ªåº“æ‰“åŒ…è¿› ipa ä¸­ï¼Œä½¿ç”¨å®ƒçš„ API å®ç°æ³¨å…¥ã€‚mobilesubstrate åº“åœ¨æˆ‘çš„ [GitHub](Dynamic%20library/dylib ) ä¸­æœ‰æä¾›ï¼Œå³æ˜¯ libsubstrate.dylib ã€‚

## æ‰“å¼€ç»ˆç«¯

Terminal ä¸€èˆ¬ Mac ç”µè„‘è‡ªå¸¦ï¼Œæ‰“å¼€ Terminal æ‰§è¡Œåç»­æ“ä½œã€‚

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/terminal.png" width="20%" />
</div>

## å®‰è£… theos

theos æ˜¯ä¸€ä¸ªè¶Šç‹±å¼€å‘å·¥å…·åŒ…ï¼Œå®ƒå¯ä»¥ç”Ÿæˆ iOS app ä»¥åŠ tweak ç­‰ç¨‹åºçš„æ¡†æ¶ï¼Œå¹¶æä¾› makefile æ¥ç¼–è¯‘ã€æ‰“åŒ…å’Œå®‰è£…ã€‚

- ä» Github ä¸‹è½½ theos ï¼Œè¿›è¡Œå¦‚ä¸‹æ“ä½œï¼š

```
export THEOS=/opt/theos
rm -rf $THEOS # å¦‚æœä¹‹å‰å·²ç»å®‰è£…è¿‡ theosï¼Œè¯·å…ˆåˆ é™¤ï¼Œç„¶åä¸‹è½½æœ€æ–°ç‰ˆ
sudo git clone --recursive https://github.com/theos/theos.git $THEOS
```

æ‰§è¡Œå‘½ä»¤åï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼š

```
Cloning into '/opt/theos'...
remote: Enumerating objects: 18, done.
remote: Counting objects: 100% (18/18), done.
remote: Compressing objects: 100% (14/14), done.
remote: Total 8802 (delta 4), reused 9 (delta 4), pack-reused 8784
Receiving objects: 100% (8802/8802), 2.20 MiB | 9.00 KiB/s, done.
Resolving deltas: 100% (5467/5467), done.
Submodule 'vendor/dm.pl' (https://github.com/theos/dm.pl.git) registered for path 'vendor/dm.pl'
Submodule 'vendor/include' (https://github.com/theos/headers.git) registered for path 'vendor/include'
Submodule 'vendor/lib' (https://github.com/theos/lib.git) registered for path 'vendor/lib'
Submodule 'vendor/logos' (https://github.com/theos/logos.git) registered for path 'vendor/logos'
Submodule 'vendor/nic' (https://github.com/theos/nic.git) registered for path 'vendor/nic'
Cloning into '/opt/theos/vendor/dm.pl'...
remote: Enumerating objects: 142, done.        
remote: Total 142 (delta 0), reused 0 (delta 0), pack-reused 142        
Receiving objects: 100% (142/142), 54.20 KiB | 9.00 KiB/s, done.
Resolving deltas: 100% (72/72), done.
...
...
...
Submodule path 'vendor/include/rocketbootstrap/LightMessaging': checked out '496257b11c3e906333797639355db9a43015eb50'
Submodule path 'vendor/lib': checked out 'b1d502cc632ec349f8e2b3df9d7630bad64fd25e'
Submodule path 'vendor/logos': checked out 'a54760ea60acf45fa48267b9fb344c0317d9351c'
Submodule path 'vendor/nic': checked out '794d210f81198c6aef4f0ab8d04bd74ffe149f51'
```

- é…ç½® ldid

ldid æ˜¯ç”¨äºå¯¹ iOS å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œç­¾åçš„å·¥å…·ï¼Œå¯ä»¥åœ¨è¶Šç‹± iOS ä¸­æ›¿æ¢ Xcode è‡ªå¸¦çš„ç­¾åå·¥å…·ã€‚

ä» [http://joedj.net/ldid](http://joedj.net/ldid) ä¸‹è½½ï¼Œå°†å…¶ç§»åŠ¨åˆ° /opt/theos/bin ç›®å½•ä¸‹ï¼Œç„¶åè®¾ç½®å¯æ‰§è¡Œæƒé™ã€‚

```
# cd <ä¸‹è½½ldidçš„ç›®å½•>
cd ~/Downloads/
sudo mv ldid /opt/theos/bin
sudo chmod 777 /opt/theos/bin/ldid
```

- é…ç½®ç¯å¢ƒå˜é‡

ä½¿ç”¨å‘½ä»¤ `vi ~/.bash_profile` æˆ–è€… `open -e ~/.bash_profile` ï¼Œåœ¨ .bash_profile æ–‡ä»¶çš„æœ€ååŠ å…¥ (å¦åˆ™æ¯æ¬¡é‡å¯ Terminal éƒ½è¦é‡æ–° export)

```
export PATH=/opt/theos/bin:$PATH
export THEOS=/opt/theos
```

ä¿å­˜å¹¶é€€å‡ºï¼Œä½¿ç”¨å‘½ä»¤ `source ~/.bash_profile` ï¼Œç«‹å³ç”Ÿæ•ˆã€‚

PS:  ä¹Ÿå¯ä»¥ä½¿ç”¨ [iOSOpenDev](http://iosopendev.com)

iOSOpenDev é›†æˆåœ¨ Xcode ä¸­ï¼Œæä¾›äº†ä¸€äº›æ¨¡æ¿ï¼Œå¯ç›´æ¥ä½¿ç”¨ Xcode è¿›è¡Œå¼€å‘ã€‚åªæ˜¯è¿™ä¸ªå·¥å…·åœæ­¢æ›´æ–°ï¼Œå¯¹é«˜ç‰ˆæœ¬çš„ Xcode ä¸èƒ½å¾ˆå¥½åœ°æ”¯æŒã€‚æœ¬äººå®‰è£…é‡åˆ°äº†è®¸å¤šé—®é¢˜ï¼Œé€šè¿‡æŸ¥é˜…è®¸å¤šçš„èµ„æ–™ï¼Œæœ€ååœ¨ Xcode ä¸­æ˜¾ç¤ºäº†è¯¥å·¥å…·ã€‚è‹¥å®‰è£…å¤±è´¥ï¼Œåˆ™å‚è€ƒ [iOSOpenDev Wiki](https://github.com/kokoabim/iOSOpenDev/wiki) æˆ–è€…å…¶å®ƒèµ„æ–™ã€‚

## tweak

### ä½•è°“ tweak ?

tweak å®šä¹‰æ˜¯ï¼šå¯¹å¤æ‚çš„ç³»ç»Ÿâ€”é€šå¸¸æ˜¯ç”µå­è®¾å¤‡â€”è¿›è¡Œå¾®è°ƒæˆ–ä¿®æ”¹æ¥å¢å¼ºå…¶åŠŸèƒ½ã€‚è€Œåœ¨ iOS å½“ä¸­ï¼Œtweak  æ˜¯æŒ‡é‚£äº›èƒ½å¤Ÿå¢å¼ºå…¶å®ƒè¿›ç¨‹åŠŸèƒ½çš„ dylib ã€‚å¯ä»¥å°† tweak ç†è§£ä¸ºä¸€ä¸ªå¤–æŒ‚ï¼Œåªä¸è¿‡è¿™ä¸ªå¤–æŒ‚æ˜¯ä»¥åŠ¨æ€é“¾æ¥åº“çš„æ–¹å¼æ³¨å…¥åˆ°ç›®æ ‡åº”ç”¨å½“ä¸­ã€‚æˆ‘ä»¬å·²ç»å¾ˆäº†è§£å¤–æŒ‚å…¶å®å°±æ˜¯ç”¨æ¥åšä¸€äº›åŸæœ¬çš„åº”ç”¨æ— æ³•åšåˆ°çš„äº‹æƒ…ã€‚

### åˆ›å»º tweak

ä½¿ç”¨ nic.pl åˆ›å»º tweak ï¼Œè‹¥æç¤ºæ— æ­¤å‘½ä»¤ï¼Œè¯·æ ¹æ®ä¸Šè¿°æ­¥éª¤é…ç½®ç¯å¢ƒå˜é‡ï¼Œæˆ–è€…ä¸å«Œéº»çƒ¦ä½¿ç”¨ /opt/theos/bin/nic.pl ï¼Œæ ¹æ®æç¤ºé€‰æ‹© iphone/tweak ï¼Œæ¥ç€åˆ†åˆ«è¾“å…¥ï¼š

- é¡¹ç›®å
- è¯¥ deb åŒ…çš„åå­—ï¼ˆç±»ä¼¼ bundle identifierï¼Œæ­¤ bundle identifier ä¸è¦ hook çš„ app çš„ bundle identifier ä¸æ˜¯åŒä¸€ä¸ªï¼‰
- ä½œè€…/ç»´æŠ¤è€…
- tweak ä½œç”¨å¯¹è±¡çš„ bundle identifierï¼ˆæ¯”å¦‚å¾®ä¿¡ä¸ºcom.tencent.xinï¼‰
- tweak å®‰è£…å®Œæˆåéœ€è¦é‡å¯çš„åº”ç”¨åï¼ˆæ¯”å¦‚å¾®ä¿¡ä¸ºWeChatï¼‰

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/nic_create_tweak.png" width="60%" />
</div>

å®Œæˆåä¼šçœ‹åˆ°å››ä¸ªæ–‡ä»¶( make åå°†ç”Ÿæˆ .theos ã€obj æ–‡ä»¶å¤¹)ï¼š**Makefile &nbsp; wcodtplugin.plist &nbsp; control &nbsp; Tweak.xm**ã€‚

- Makefile

å·¥ç¨‹ç”¨åˆ°çš„æ–‡ä»¶ã€æ¡†æ¶ã€åº“ç­‰ä¿¡æ¯ã€‚è¯¥æ–‡ä»¶è¿‡äºç®€å•ï¼Œè¿˜éœ€è¦æ·»åŠ ä¸€äº›ä¿¡æ¯ï¼Œå¦‚ï¼š<br />

æŒ‡å®šå¤„ç†å™¨æ¶æ„ `ARCHS = armv7 arm64` <br />
æŒ‡å®š SDK ç‰ˆæœ¬ `TARGET = iphone:latest:8.0` <br />
å¯¼å…¥æ‰€éœ€çš„ framework ç­‰ã€‚<br />

ä¿®æ”¹åçš„ Makefile æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š

```
ARCHS = armv7 arm64
TARGET = iphone:latest:8.0
THEOS_MAKE_PATH = /opt/theos/makefiles

include $(THEOS_MAKE_PATH)/common.mk

TWEAK_NAME = wcodtplugin
$(TWEAK_NAME)_FILES = $(wildcard src/*.m) src/Tweak.xm
$(TWEAK_NAME)_FRAMEWORKS = UIKit AVFoundation CoreLocation

src/xxa.m_CFLAGS = -fobjc-arc
...
src/xxz.m_CFLAGS = -fobjc-arc

include $(THEOS_MAKE_PATH)/tweak.mk

after-install::
    install.exec "killall -9 WeChat"
```

- wcodtplugin.plist

è¯¥æ–‡ä»¶ä¸­çš„ Bundles : æŒ‡å®š bundle ä¸º tweak çš„ä½œç”¨å¯¹è±¡ï¼Œä¹Ÿå¯æ·»åŠ å¤šä¸ª bundle ï¼ŒæŒ‡å®šå¤šä¸ªä¸º tweak ä½œç”¨å¯¹è±¡ã€‚

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/tweak_plist.png" width="60%" />
</div>

- control

è¯¥ tweak æ‰€éœ€çš„åŸºæœ¬ä¿¡æ¯ (å…¶å®å¤§éƒ¨åˆ†éƒ½æ˜¯åˆ›å»º tweak æ‰€å¡«å†™çš„ä¿¡æ¯) 

```
Package: com.aple.wcodtplugin
Name: wcodtplugin
Depends: mobilesubstrate
Version: 0.0.1 # ç‰ˆæœ¬å·
Architecture: iphoneos-arm
Description: An awesome MobileSubstrate tweak! # å¡«å†™é¡¹ç›®æè¿°
Maintainer: dyf # ç»´æŠ¤è€…
Author: dyf # ä½œè€…
Section: Tweaks
```

- Tweak.xm

é‡ç‚¹æ–‡ä»¶ï¼Œç”¨æ¥ç¼–å†™ hook ä»£ç ï¼Œå› ä¸ºæ”¯æŒ Logos å’Œ C/C++ è¯­æ³•ï¼Œå¯ä»¥è®©æˆ‘ä»¬ä¸ç”¨å»å†™ä¸€äº› runtime æ–¹æ³• (å¿…è¦æ—¶å€™è¿˜æ˜¯è¦å†™) ï¼Œä»è€Œè¿›è¡Œ hook ã€‚

PS:  .x æ–‡ä»¶æ”¯æŒ Logos è¯­æ³•ï¼Œ.xm æ–‡ä»¶æ”¯æŒ Logos å’Œ C/C++ è¯­æ³•ã€‚

### Logos å¸¸ç”¨è¯­æ³•

- %hook

æŒ‡å®šéœ€è¦ hook çš„ç±»ï¼Œä»¥%endç»“å°¾ã€‚

- %orig

åœ¨ %hook å†…éƒ¨ä½¿ç”¨ï¼Œæ‰§è¡Œ hook ä½çš„æ–¹æ³•åŸä»£ç ã€‚

- %new

åœ¨ %hook å†…éƒ¨ä½¿ç”¨ï¼Œç»™ class æ·»åŠ æ–°æ–¹æ³•ï¼Œä¸ class_addMethod ç›¸åŒã€‚<br />
ä¸ Category ä¸­æ·»åŠ æ–¹æ³•çš„åŒºåˆ«ï¼šCategory ä¸ºç¼–è¯‘æ—¶æ·»åŠ ï¼Œclass_addMethod ä¸ºåŠ¨æ€æ·»åŠ ã€‚<br />
warning ï¼šæ·»åŠ çš„æ–¹æ³•éœ€è¦åœ¨ @interface ä¸­è¿›è¡Œå£°æ˜ã€‚ <br />

- %c

è·å–ä¸€ä¸ªç±»ï¼Œç­‰åŒäº objc_getClass ã€NSClassFromString ã€‚

- MSHookIvar<id>(self, "m_tableViewMgr")

åœ¨ %hook å†…éƒ¨ä½¿ç”¨ï¼Œè·å–ä¸€ä¸ªç±»çš„ç§æœ‰æˆå‘˜å˜é‡ã€‚

> %hookã€%logã€%orig ç­‰éƒ½æ˜¯ mobilesubstrate çš„ MobileHooker æ¨¡å—æä¾›çš„å®ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ %group  %init  %ctor ç­‰ï¼Œå…¶å®ä¹Ÿå°±æ˜¯æŠŠ method swizzling ç›¸å…³çš„æ–¹æ³•å°è£…æˆäº†å„ç§å®æ ‡è®°ï¼Œè‹¥æƒ³æ·±å…¥äº†è§£ï¼Œè¯·å·¦è½¬ [Google](https://www.google.com) æˆ–è€… [Baidu](https://www.baidu.com) ã€‚

### ç¼–å†™ Tweak.xm

åœ¨ç†Ÿæ‚‰å„ç§è¯­æ³•ä¹‹åï¼Œå¯ä»¥è¿›è¡Œç¼–å†™ä»£ç äº†ï¼Œå…¶ä¸­ MMUIViewController ä¸ºå¾®ä¿¡çš„åŸºç¡€çš„ ViewController ã€‚æˆ‘ä»¬é€šè¿‡ hook viewDidApper: æ¥è¿›è¡Œ Hello World! å¼¹çª—ã€‚ 

ç¼–å†™ä¸€ä¸ª hook æ¥å£å£°æ˜å¤´æ–‡ä»¶ `HookInterfaceStatment.h`ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@interface MMUIViewController : UIViewController

- (void)startLoadingBlocked;
- (void)startLoadingNonBlock;
- (void)startLoadingWithText:(NSString *)text;
- (void)stopLoading;
- (void)stopLoadingWithFailText:(NSString *)text;
- (void)stopLoadingWithOKText:(NSString *)text;

// Added method.
- (void)helloWorld;

@end
```

ç¼–å†™ Tweak.xm ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
#import "HookInterfaceStatment.h"

%hook MMUIViewController

- (void)viewWillAppear:(_Bool)arg1 {
    %orig;
    [self helloWorld];
}

%new
- (void)helloWorld {
    UIAlertController *alertController = ({
        UIAlertController *_alertController = [UIAlertController alertControllerWithTitle:@"Hello World!" message:nil preferredStyle:UIAlertControllerStyleAlert];
        [_alertController addAction:[UIAlertAction actionWithTitle:@"ç¡®å®š" style:UIAlertActionStyleDestructive handler:^(UIAlertAction * _Nonnull action) {}]];
        [_alertController addAction:[UIAlertAction actionWithTitle:@"å–æ¶ˆ" style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) {}]];
        _alertController;
    });
    [self presentViewController:alertController animated:YES completion:NULL];
}

%end
```

### ç¼–è¯‘

ä½¿ç”¨ `make` è¿›è¡Œç¼–è¯‘ï¼Œè‹¥æƒ³é‡æ–°ç¼–è¯‘ï¼Œåˆ™å…ˆ `make clean` ã€‚make ç¼–è¯‘å®Œæˆåï¼Œåœ¨å½“å‰æ–‡ä»¶å¤¹ä¸‹é¢å°†ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶å¤¹: .theos ä¸ obj ï¼Œå…¶ä¸­ç¼–è¯‘å®Œæˆçš„åŠ¨æ€åº“å°±åœ¨ .thoes/obj/debug çš„ä¸‹é¢ï¼Œä¸å·¥ç¨‹åç›¸åŒã€‚

- é—®é¢˜1

```
Makefile:6: theos/makefiles/common.mk: Not a directory
Makefile:25: /tweak.mk: No such file or directory
make: *** No rule to make target `/tweak.mk'.  Stop.
```

è§£å†³åŠæ³•ï¼šé¦–å…ˆç¡®ä¿å®‰è£…å¹¶é…ç½®äº† theos ï¼Œå…¶æ¬¡ä¿®æ”¹ Makefile æ–‡ä»¶ï¼Œåœ¨ `$(THEOS)/makefiles` ä»£ç è¡Œä¸Šæ–¹å®šä¹‰ `THEOS_MAKE_PATH = /opt/theos/makefiles` ï¼Œå°† `$(THEOS)/makefiles` æ›¿æ¢æˆ `$(THEOS_MAKE_PATH)` ã€‚

- é—®é¢˜2

```
bash: ldid: command not found
make[2]: *** [/Users/xxx/Desktop/wcodtplugin/.theos/obj/debug/wcodtplugin.dylib] Error 6
rm /Users/xxx/Desktop/wcodtplugin/.theos/obj/debug/wcodtplugin.dylib.47ba6b93.unsigned
make[1]: *** [internal-library-all_] Error 2
make: *** [wcodtplugin.all.tweak.variables] Error 2
```

è§£å†³åŠæ³•ï¼šæŒ‰ç…§é…ç½® ldid æ­¥éª¤æ‰§è¡Œï¼Œé‡æ–°ç¼–è¯‘ã€‚

- é—®é¢˜3

```
xcrun: error: SDK "iphoneos" cannot be located
xcrun: error: SDK "iphoneos" cannot be located
==> Error: You do not have any SDKs in /Library/Developer/CommandLineTools/Platforms/iPhoneOS.platform/Developer/SDKs or /opt/theos/sdks.
make: *** [before-all] Error 1
```

è§£å†³åŠæ³•ï¼šåœ¨ç»ˆç«¯æ‰§è¡Œå‘½ä»¤ `sudo xcode-select --switch /Applications/Xcode.app` å³å¯ã€‚


- é—®é¢˜4 (ä»£ç æŠ¥é”™)

```
> Making all for tweak wcodtpluginâ€¦
==> Preprocessing Tweak.xmâ€¦
==> Compiling Tweak.xm (armv7)â€¦
Tweak.xm:5:26: error: expected ';' after expression
... UIAlertController *_alertController = [UIAlertController alertControllerWithTitle...
                            ^
                            ;
1 error generated.
make[3]: *** [/Users/xxx/Desktop/wcodtplugin/.theos/obj/debug/armv7/Tweak.xm.8aee9f68.o] Error 1
rm /Users/xxx/Desktop/wcodtplugin/.theos/obj/debug/armv7/Tweak.xm.mm
make[2]: *** [/Users/xxx/Desktop/wcodtplugin/.theos/obj/debug/armv7/wcodtplugin.dylib] Error 2
make[1]: *** [internal-library-all_] Error 2
make: *** [wcodtplugin.tweak.variables] Error 2
```

è§£å†³åŠæ³•ï¼šæ ¹æ®é”™è¯¯æç¤ºï¼Œæ‰¾åˆ°æŠ¥é”™çš„ä»£ç è¿›è¡Œä¿®æ”¹ï¼Œé‡æ–°ç¼–è¯‘ã€‚

- é—®é¢˜5 (æ‰“åŒ…å‡ºé”™)

```
> Making all for tweak wcodtpluginâ€¦
make[2]: Nothing to be done for `internal-library-compile'.
> Making stage for tweak wcodtpluginâ€¦
Can't locate IO/Compress/Lzma.pm in @INC (you may need to install the IO::Compress::Lzma module) (@INC contains: /usr/local/Cellar/perl/5.26.2/lib/perl5/site_perl/5.26.2/darwin-thread-multi-2level /usr/local/Cellar/perl/5.26.2/lib/perl5/site_perl/5.26.2 /usr/local/Cellar/perl/5.26.2/lib/perl5/5.26.2/darwin-thread-multi-2level /usr/local/Cellar/perl/5.26.2/lib/perl5/5.26.2 /usr/local/lib/perl5/site_perl/5.26.2/darwin-thread-multi-2level /usr/local/lib/perl5/site_perl/5.26.2) at /opt/theos/bin/dm.pl line 12.
BEGIN failed--compilation aborted at /opt/theos/bin/dm.pl line 12.
make: *** [internal-package] Error 2
```

è§£å†³åŠæ³•ï¼š

```
1. /opt/theos/vendor/dm.pl/dm.pl
# æ³¨é‡Šæ‰ç¬¬12ã€13è¡Œ
# use IO::Compress::Lzma;
# use IO::Compress::Xz;

2. /opt/theos/makefiles/package/deb.mk
# ç¬¬6è¡Œ lzma æ”¹ä¸º gzip
_THEOS_PLATFORM_DPKG_DEB_COMPRESSION ?= gzip
```

æœ€åé‡æ–° make package ï¼ŒæˆåŠŸäº†ã€‚

## ç›®å½•ä»‹ç»

- [Dynamic library](Dynamic%20library) - dylib ç›®å½• (Raw Dynamic Library) å’Œ modify ç›®å½• (Modified Dynamic Library) ï¼Œå¯ç›´æ¥æ‹¿æ¥æ³¨å…¥ã€‚
- [Hook-Tools](Hook-Tools) - Hook ä½¿ç”¨çš„å·¥å…·ã€‚
    - dumpdecrypted - ç”¨äºè§£å¯† iOS çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç ¸å£³æ—¶å¯ä¸éœ€è¦ã€‚
    - otool - ä¸€èˆ¬ Mac è‡ªå¸¦ï¼Œç”¨äºæŸ¥çœ‹è§£å¯†åæ–‡ä»¶çš„ä¾èµ–é¡¹æ£€æŸ¥ã€‚
    - install_name_tool - ä¸€èˆ¬ Mac è‡ªå¸¦ï¼Œæ›´æ”¹åŠ¨æ€åº“çš„ä¾èµ–ã€‚
    - yoyolib - ç”¨äºå‘ iOS çš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­æ³¨å…¥ dylib ã€‚
    - optool - å°†åŠ¨æ€åº“æ³¨å…¥ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚
    - class-dump - å¯¼å‡ºappæ‰€æœ‰å¤´æ–‡ä»¶ (`class-dump -s -S -H ~/Desktop/xx.app -o ~/Desktop/xx-headers`)ã€‚
    - ldid - ç”¨äºå¯¹ iOS å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œç­¾åçš„å·¥å…·ï¼Œåœ¨è¶Šç‹± iOS ä¸­æ›¿æ¢ Xcode è‡ªå¸¦çš„ç­¾åå·¥å…·ã€‚
    - PackageApplication -  ä¸»è¦ç”¨æ¥é€šè¿‡è„šæœ¬æ‰“åŒ… ipa æ–‡ä»¶ã€‚
    - 010Editor701 - ä¸€æ¬¾å…¨æ–°æ¦‚å¿µçš„åå…­è¿›åˆ¶ç¼–è¾‘å™¨ï¼Œå…¶æœ€å¼ºå¤§çš„åŠŸèƒ½åœ¨äºæ”¯æŒæ¨¡æ¿å’Œè„šæœ¬æ“ä½œã€‚
        - [010Editor æœ€æ–°ç‰ˆ 8.0.1 é€†å‘åˆ†æ](https://www.52pojie.cn/forum.php?mod=viewthread&tid=684119&page=)
    - MachOView - ç”¨äºå¯¹ mach-o æ–‡ä»¶åˆ†æçš„å·¥å…·ã€‚
    - DYFCodesign - ç”¨äºå¯¹ iOS app è¿›è¡Œè„šæœ¬é‡ç­¾åã€‚
    - [ios-app-signer](https://github.com/dgynfi/OpenSource#Mac) - æ‰“åŒ… ipa ä¸é‡ç­¾åå›¾å½¢åŒ–å·¥å…·ã€‚
    - iOSOpenDev - Xcode å¢å¼ºå·¥å…·ï¼Œé€šè¿‡å®ƒç”Ÿæˆç”¨äºæ³¨å…¥çš„ dylib åº“ã€‚å»ºè®®ç”¨ theos ç¼–è¯‘ tweak é¡¹ç›®ç”Ÿæˆæ³¨å…¥çš„ dylib åº“ã€‚
- [Resources](Resources) - Icon ç›®å½• (å¸¦æŠ¢çº¢åŒ…çš„Icon) å’Œ wav ç›®å½• (éŸ³é¢‘æ–‡ä»¶) ç­‰ã€‚
- [WeChatPluginDev](WeChatPluginDev/wapleodtcorexpc) - å¾®ä¿¡æ’ä»¶ tweak æºç å¼€å‘ã€‚

## è·å–ç ¸å£³ç‰ˆæœ¬çš„å¾®ä¿¡

1. ç™¾åº¦ç½‘ç›˜ä¸‹è½½

[https://pan.baidu.com/s/1eT3tgfQRjIHUu3PL77YY9Q - æå–ç ï¼šo8sa](https://pan.baidu.com/s/1eT3tgfQRjIHUu3PL77YY9Q)

2. SSH æœåŠ¡

å®ç°åœ¨è¶Šç‹±æ‰‹æœºä¸Šè¿œç¨‹è¿›è¡Œ ssh æœåŠ¡ï¼Œåœ¨ Cydia ä¸­å®‰è£… OpenSSH ã€‚

- ssh : è¿œç¨‹ç™»å½•

```
# æŒ‡ä»¤ ssh user@ip
ssh mobile@192.168.6.6
```

- scp : è¿œç¨‹æ‹·è´

æœ¬åœ°æ–‡ä»¶æ‹·è´åˆ° iOS ä¸Š (è‹¥ä» iOS ä¸Šæ‹·è´åˆ°æœ¬åœ°ï¼Œåˆ™ç›¸å) ã€‚

```
# æŒ‡ä»¤ scp /path/to/localFile user@ip:/path/to/remoteFile
scp ~/Desktop/icon.png root@192.168.6.6:/var/tmp/
```

> æ³¨æ„ï¼ŒOpenSSH é»˜è®¤ç™»å½•å¯†ç ä¸º alpine ï¼ŒiOS ä¸Šçš„ç”¨æˆ·åªæœ‰ root å’Œ mobileï¼Œä¿®æ”¹å¯†ç ä½¿ç”¨ passwd root (mobile) ã€‚

3. ä½¿ç”¨ Clutch å¯¹è¶Šç‹±æ‰‹æœºä¸Šçš„åº”ç”¨è¿›è¡Œç ¸å£³

- å°† Cluth ä»“åº“ clone åˆ°æœ¬åœ°ï¼š

```
git clone https://github.com/KJCracks/Clutch
cd Clutch
```

- ä½¿ç”¨ Xcode è¿›è¡Œæ„å»ºï¼Œå¾—åˆ°å¯æ‰§è¡Œæ–‡ä»¶ï¼š

```
xcodebuild -project Clutch.xcodeproj -configuration Release ARCHS="armv7 arm64" build
```

- å°†å¯æ‰§è¡Œæ–‡ä»¶ clutch æ‹·è´åˆ°æ‰‹æœºä¸Šï¼š

```
scp Clutch/clutch root@<your.device.ip>:/usr/bin/
```

- å…ˆ ssh åˆ°è¶Šç‹±æ‰‹æœºä¸Šï¼Œç„¶åæŸ¥çœ‹å½“å‰å®‰è£…çš„åº”ç”¨ï¼š

```
ssh root@<your.device.ip>

# åˆ—å‡ºå½“å‰å®‰è£…çš„åº”ç”¨
clutch -i

# Installed apps:
# 1: WeChat <com.tencent.xin>
# ...
```

- å¼€å§‹ç ¸å£³

```
# clutch -d <bundle identifier>
clutch -d com.tencent.xin

# Zipping WeChat.app
# Swapping architectures..
# ASLR slide: 0xb3000
# ...
# writing new checksum
# DONE: /private/var/mobile/Documents/Dumped/com.tencent.xin-iOS9.2-(Clutch-2.0.4).ipa
# Finished dumping com.tencent.xin in 76.9 seconds
```

- å°†ç ¸å®Œå£³çš„ ipa åŒ…æ‹·å› Mac ç”µè„‘ä¸Š

```
mv /private/var/mobile/Documents/Dumped/com.tencent.xin-iOS9.2-\(Clutch-2.0.4\).ipa /private/var/mobile/Documents/Dumped/WeChat.ipa

scp root@<your.device.ip>:/private/var/mobile/Documents/Dumped/WeChat.ipa ~/Desktop/
```

## æ³¨å…¥åŠ¨æ€åº“å’Œé‡ç­¾åæ‰“åŒ…åº”ç”¨

æœ¬æ–‡çš„é‡ç‚¹å†…å®¹ï¼ŒåŠ¨æ€åº“å¯ä»¥åˆ°æˆ‘çš„[GitHubä»“åº“](Dynamic%20library)é‡Œä¸‹è½½ã€‚æ¥ä¸‹æ¥è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œæ‰§è¡Œï¼š

### è§£å‹ ipa (Unzip ipa)

```
# cd <å¾®ä¿¡ipaä¸‹è½½ç›®å½•>
cd ~/Downloads/

# ä»¥ å¾®ä¿¡-7.0.5 ç‰ˆæœ¬ä¸ºä¾‹ï¼Œæ³¨æ„ï¼šä¸‹è½½çš„ç‰ˆæœ¬å¿…é¡»ä¸ºç ´è§£ç‰ˆï¼Œå¦‚ä½•æŸ¥çœ‹ï¼Ÿè¯·é˜…è¯»æŸ¥çœ‹ app æ˜¯å¦è¢«åŠ å¯† (Check app)
unzip -o å¾®ä¿¡-7.0.5\(è¶Šç‹±åº”ç”¨\).ipa -d ./

# é™é»˜è§£å‹
# unzip -q -o å¾®ä¿¡-7.0.5\(è¶Šç‹±åº”ç”¨\).ipa -d ./

# å°† Payload ç§»è‡³æ¡Œé¢
mv ./Payload/ ~/Desktop/
```

### æŸ¥çœ‹ app æ˜¯å¦è¢«åŠ å¯† (Check app)

otool å¯ä»¥è¾“å‡º app çš„ load commandsï¼Œç„¶åé€šè¿‡æŸ¥çœ‹ cryptid è¿™ä¸ªæ ‡å¿—ä½æ¥åˆ¤æ–­ app æ˜¯å¦è¢«åŠ å¯†ï¼Œ1ä»£è¡¨åŠ å¯†ï¼Œ0ä»£è¡¨è¢«è§£å¯†ã€‚

```
# è¿›å…¥æ¡Œé¢
cd ~/Desktop/

# æŸ¥çœ‹ app æ˜¯å¦è¢«åŠ å¯†
otool -l Payload/WeChat.app/WeChat | grep -B 2 crypt
```

ç»“æœæ˜¾ç¤ºå¦‚ä¸‹ï¼š

```
otool -l Payload/WeChat.app/WeChat | grep -B 2 crypt
          cmd LC_ENCRYPTION_INFO_64
      cmdsize 24
     cryptoff 16384
    cryptsize 100237312
      cryptid 0
```

### å…‹éš†ä»“åº“ (Clone Repository)

```
# è¿›å…¥æ¡Œé¢
cd ~/Desktop/

# å…‹éš†
git clone https://github.com/dgynfi/WeChat_tweak.git
```

### ç¼–è¯‘ tweak é¡¹ç›® (Compile Tweak Project)

```
cd WeChat_tweak/WeChatPluginDev/wapleodtcorexpc/
# compile
make
```

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/tweak_make.png" width="60%" />
</div>

ç¼–è¯‘æ—¶å‡ºç°çš„é—®é¢˜æˆ–é”™è¯¯ï¼Œè¯·æŸ¥çœ‹ä¸Šè¿°[é—®é¢˜æè¿°å’Œè§£å†³æ–¹æ³•](#ç¼–è¯‘)ã€‚

å°†åŠ¨æ€åº“æ‹·è´è‡³æ¡Œé¢ï¼š

```
# å°† wapleodtcorexpc.dylib åº“æ‹·è´è‡³æ¡Œé¢
cp .theos/obj/debug/wapleodtcorexpc.dylib ~/Desktop/

# ç›´æ¥æ‰“å¼€ç›®å½•ï¼Œå°† wapleodtcorexpc.dylib åº“æ‹·è´æˆ–æ‹–æ‹½è‡³æ¡Œé¢
# open .theos/obj/debug/
```

### æ›´æ”¹åŠ¨æ€åº“çš„ä¾èµ– (Change Dynamic Library Dependencies)

å°† libsubstrate.dylib åº“æ‹·è´è‡³æ¡Œé¢ï¼š

```
# è¿›å…¥æ¡Œé¢
cd ~/Desktop/

# å°† libsubstrate.dylib åº“æ‹·è´è‡³æ¡Œé¢
cp WeChat_tweak/Dynamic\ library/dylib/libsubstrate.dylib ~/Desktop/
```

å³é”® wapleodtcorexpc.dylib ï¼Œé€‰æ‹©æ˜¾ç¤ºç®€ä»‹ï¼Œåœ¨åç§°ä¸æ‰©å±•åå¤„å°† wapleodtcorexpc.dylib ä¿®æ”¹æˆ wapleodtcorexpc ï¼Œå›è½¦å¹¶ç§»é™¤ã€‚

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/rm_ext.png" width="60%" />
</div>

åŒç†ï¼Œå³é”® libsubstrate.dylib ï¼Œé€‰æ‹©æ˜¾ç¤ºç®€ä»‹ï¼Œåœ¨åç§°ä¸æ‰©å±•åå¤„å°† libsubstrate.dylib ä¿®æ”¹æˆ waplesubstrate ï¼Œå›è½¦å¹¶ç§»é™¤ã€‚

æ‰§è¡Œæ›´æ”¹åŠ¨æ€åº“çš„ä¾èµ–å‘½ä»¤ï¼š

```
install_name_tool -change /Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate @loader_path/waplesubstrate wapleodtcorexpc
```

æŸ¥çœ‹ä¾èµ–é¡¹ï¼Œæ£€æŸ¥æ˜¯å¦æ›´æ”¹æˆåŠŸï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```
otool -L wapleodtcorexpc
```

æ˜¾ç¤ºå¦‚ä¸‹ï¼š

```
wapleodtcorexpc (architecture armv7):
    /Library/MobileSubstrate/DynamicLibraries/wapleodtcorexpc.dylib (compatibility version 0.0.0, current version 0.0.0)
    /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)
    /System/Library/Frameworks/Foundation.framework/Foundation (compatibility version 300.0.0, current version 1570.15.0)
    /System/Library/Frameworks/CoreFoundation.framework/CoreFoundation (compatibility version 150.0.0, current version 1570.15.0)
    /System/Library/Frameworks/UIKit.framework/UIKit (compatibility version 1.0.0, current version 61000.0.0)
    /System/Library/Frameworks/AVFoundation.framework/AVFoundation (compatibility version 1.0.0, current version 2.0.0)
    /System/Library/Frameworks/CoreLocation.framework/CoreLocation (compatibility version 1.0.0, current version 2245.12.30)
    @loader_path/waplesubstrate (compatibility version 0.0.0, current version 0.0.0)
    /usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 400.9.4)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.250.1)
    /System/Library/Frameworks/CoreVideo.framework/CoreVideo (compatibility version 1.2.0, current version 1.5.0)
wapleodtcorexpc (architecture arm64):
    /Library/MobileSubstrate/DynamicLibraries/wapleodtcorexpc.dylib (compatibility version 0.0.0, current version 0.0.0)
    /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 228.0.0)
    /System/Library/Frameworks/Foundation.framework/Foundation (compatibility version 300.0.0, current version 1570.15.0)
    /System/Library/Frameworks/CoreFoundation.framework/CoreFoundation (compatibility version 150.0.0, current version 1570.15.0)
    /System/Library/Frameworks/UIKit.framework/UIKit (compatibility version 1.0.0, current version 61000.0.0)
    /System/Library/Frameworks/AVFoundation.framework/AVFoundation (compatibility version 1.0.0, current version 2.0.0)
    /System/Library/Frameworks/CoreLocation.framework/CoreLocation (compatibility version 1.0.0, current version 2245.12.30)
    @loader_path/waplesubstrate (compatibility version 0.0.0, current version 0.0.0)
    /usr/lib/libc++.1.dylib (compatibility version 1.0.0, current version 400.9.4)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1252.250.1)
    /System/Library/Frameworks/CoreVideo.framework/CoreVideo (compatibility version 1.2.0, current version 1.5.0)
```

CydiaSubstrate åªæœ‰è¶Šç‹±çš„æ‰‹æœºä¸Šæ‰æœ‰ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ›´æ”¹å¹¶å¯¼å…¥ã€‚ä»ä¸Šå¯è§ï¼Œ`/Library/Frameworks/CydiaSubstrate.framework/CydiaSubstrate` æ›´æ”¹æˆäº† `@loader_path/waplesubstrate` ï¼Œè¿™è¡¨æ˜åŠ¨æ€åº“çš„ä¾èµ–æ›´æ”¹æˆåŠŸã€‚

### ç§»é™¤æ¶æ„ (Remove Architectures) 

å¯¹äºæ²¡æœ‰å¼ºè¿«è¯çš„åŒå­¦æ¥è¯´ï¼Œè¿™æ­¥å¯ç•¥è¿‡ã€‚ç›®å‰ `WeChat` å¯æ‰§è¡Œæ–‡ä»¶åªæœ‰ `arm64` æ¶æ„ï¼Œåœ¨ä»¥å‰ç‰ˆæœ¬ä¸­ï¼Œè‹¥ç§»é™¤ `armv7` æ¶æ„ï¼Œåˆ™å¯ä»¥å¤§å¤§å‡å°‘åŒ…çš„å¤§å°ï¼Œä»¥èŠ‚çœæ‰‹æœºç©ºé—´ã€‚

```
# è¿›å…¥æ¡Œé¢ï¼Œç¡®ä¿å½“å‰åœ¨æ¡Œé¢ä¸Šæ“ä½œ
cd ~/Desktop/

lipo -info waplesubstrate 
# Architectures in the fat file: waplesubstrate are: armv7 arm64 

lipo waplesubstrate -remove armv7 -output ./waplesubstrate 

lipo -info waplesubstrate 
# Architectures in the fat file: waplesubstrate are: arm64 

lipo -info wapleodtcorexpc 
# Architectures in the fat file: wapleodtcorexpc are: armv7 arm64

lipo wapleodtcorexpc -remove armv7 -output ./wapleodtcorexpc

lipo -info wapleodtcorexpc 
# Architectures in the fat file: wapleodtcorexpc are: arm64
```

### æ³¨å…¥åŠ¨æ€åº“ (Install Dynamic Libraries)

```
# è¿›å…¥æ¡Œé¢ï¼Œç¡®ä¿å½“å‰åœ¨æ¡Œé¢ä¸Šæ“ä½œ
# cd ~/Desktop/

# @executable_path æ˜¯ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼ŒæŒ‡çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„
./WeChat_tweak/Hook-Tools/optool install -c load -p "@executable_path/wapleodtcorexpc" -t Payload/WeChat.app/WeChat
```

æ³¨å…¥è¿‡ç¨‹æ˜¾ç¤ºå¦‚ä¸‹ï¼š

```
Found thin header...
Inserting a LC_LOAD_DYLIB command for architecture: arm64
Successfully inserted a LC_LOAD_DYLIB command for arm64
Writing executable to Payload/WeChat.app/WeChat...
```

å°†åŠ¨æ€åº“æ‹·è´è‡³äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ï¼Œæ“ä½œå¦‚ä¸‹ï¼š

```
# è¿›å…¥æ¡Œé¢ï¼Œç¡®ä¿å½“å‰åœ¨æ¡Œé¢ä¸Šæ“ä½œ
# cd ~/Desktop/

# å°†åŠ¨æ€åº“æ‹·è´è‡³äºŒè¿›åˆ¶æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•
cp waplesubstrate wapleodtcorexpc Payload/WeChat.app/
```

### æ‰“å¼€ WeChat.app ç›®å½• (Open WeChat.app)

- è¿›å…¥ WeChat.app ç›®å½•

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/show_wechatapp_dir.png" width="60%" />
</div>

- æ‰¾å‡º Info.plist æ–‡ä»¶

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/found_Info.plist.png" width="60%" />
</div>

åŒå‡»ï¼Œé»˜è®¤ Xcode æ‰“å¼€ï¼Œä¿®æ”¹ Info.plist ä¸­çš„ Bundle display name å’Œ Bundle identifierï¼Œå°† WeChatBundleVersion çš„ Value ä¿®æ”¹æˆ Bundle version çš„ Valueï¼Œå°† URL types -> URL identifier ä¿®æ”¹æˆæ–°çš„ Bundle identifierï¼Œåˆ é™¤ build_time, by, path, rev, tag, uuid, ver ç­‰ Keyã€‚

- åˆ é™¤ PlugIns å’Œ Watch ç›®å½•ä¸­çš„æ–‡ä»¶

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/del_files.png" width="60%" />
</div>

- åˆ é™¤ _CFBundleDisplayName

åˆ é™¤  zh_CN.lproj  InfoPlist.strings  _CFBundleDisplayName  <br />
åˆ é™¤  zh_HK.lproj  InfoPlist.strings  _CFBundleDisplayName  <br />
åˆ é™¤  zh_TW.lproj  InfoPlist.strings  _CFBundleDisplayName  <br />
åˆ é™¤  en.lproj         InfoPlist.strings  _CFBundleDisplayName  <br />

- åˆ é™¤ Entitlements

åˆ é™¤  Entitlements_for_appstore.plist  <br />
åˆ é™¤  Entitlements_for_ext.plist  <br />
åˆ é™¤  Entitlements_for_jailbreak.plist  <br />
åˆ é™¤  Entitlements_wc_for_ext.plist  <br />
åˆ é™¤  Entitlements_wc.plist  <br />
åˆ é™¤  Entitlements_wx_for_ext.plist  <br />
åˆ é™¤  Entitlements_wx.plist  <br />

 ### é‡ç­¾ååŠ¨æ€åº“ (Resign Dynamic Libraries)

æ‰“å¼€é’¥åŒ™ä¸²è®¿é—®

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/keychain_access.png" width="20%" />
</div>

ç‚¹å‡»ç™»å½• -> æˆ‘çš„è¯ä¹¦ï¼Œæ‰¾å‡ºè¦ç­¾åçš„è¯ä¹¦ï¼Œå³å‡»æ˜¾ç¤ºç®€ä»‹ï¼Œæ‰¾åˆ°å¸¸ç”¨åç§°ï¼Œç„¶åæ‹·è´åé¢çš„å­—ç¬¦ä¸²ã€‚

æ‰§è¡Œé‡ç­¾åï¼š

```
codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/waplesubstrate 
# Payload/WeChat.app/waplesubstrate: replacing existing signature

codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/wapleodtcorexpc
# Payload/WeChat.app/wapleodtcorexpc: replacing existing signature

codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/Frameworks/andromeda.framework
# Payload/WeChat.app/Frameworks/andromeda.framework: replacing existing signature

codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/Frameworks/mars.framework
# Payload/WeChat.app/Frameworks/mars.framework: replacing existing signature

codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/Frameworks/marsbridgenetwork.framework
# Payload/WeChat.app/Frameworks/marsbridgenetwork.framework: replacing existing signature

codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/Frameworks/matrixreport.framework
# Payload/WeChat.app/Frameworks/matrixreport.framework: replacing existing signature

codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/Frameworks/OpenSSL.framework
# Payload/WeChat.app/Frameworks/OpenSSL.framework: replacing existing signature

codesign -f -s "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" Payload/WeChat.app/Frameworks/ProtobufLite.framework
# Payload/WeChat.app/Frameworks/ProtobufLite.framework: replacing existing signature
```

### é‡ç­¾ååº”ç”¨ (Resign app)

æ‰“å¼€ Provisioning Profiles ç›®å½•

```
# æ‰“å¼€ Provisioning Profiles ç›®å½•
open ~/Library/MobileDevice/Provisioning\ Profiles/ 
```

åœ¨ Finder å·¥å…·æ é€‰æ‹©ä»¥åˆ†æ æˆ–ç”»å»Šæ–¹å¼æ˜¾ç¤ºï¼Œç„¶åé€ä¸€ç‚¹å‡» xxx.mobileprovision æ–‡ä»¶ï¼Œæ‰¾å‡ºç›¸åŒ¹é…çš„ Bundle identifier çš„é…ç½®æ–‡ä»¶ ã€‚ä¹Ÿå¯ä»¥ç›´æ¥ä»è‹¹æœå¼€å‘è€…åå°ä¸‹è½½è¯ä¹¦å’Œ  xxx.mobileprovision é…ç½®æ–‡ä»¶ï¼Œå¯¼å…¥è¯ä¹¦æˆ– p12 æ–‡ä»¶å’Œ xxx.mobileprovision é…ç½®æ–‡ä»¶ (å¯ç›´æ¥ä½¿ç”¨) ã€‚

æˆ–è€…ç”¨ cat å‘½ä»¤é€ä¸€æŸ¥çœ‹ xxx.mobileprovision æ–‡ä»¶

```
cat ~/Library/MobileDevice/Provisioning\ Profiles/ece5c913-5c15-45fd-82e3-90f23739521f.mobileprovision
...
cat ~/Library/MobileDevice/Provisioning\ Profiles/269bffd1-3743-4014-bf07-4eb94c048460.mobileprovision
```

å°† xxx.mobileprovision æ–‡ä»¶æ‹·è´è‡³æ¡Œé¢

```
cp ~/Library/MobileDevice/Provisioning\ Profiles/269bffd1-3743-4014-bf07-4eb94c048460.mobileprovision ~/Desktop/wcpl_adhoc.mobileprovision
```

æ‰§è¡Œé‡ç­¾ååº”ç”¨ï¼š

```
# è¿›å…¥æ¡Œé¢ï¼Œç¡®ä¿å½“å‰åœ¨æ¡Œé¢ä¸Šæ“ä½œ
cd ~/Desktop/

./WeChat_tweak/Hook-Tools/DYFCodesign Payload/ "iPhone Developer: xxx@qq.com (9ZU3R2F3D4)" wcpl_adhoc.mobileprovision 
# /Users/xxx/Desktop/Payload/WeChat.app: replacing existing signature
```

### æ‰“åŒ…åº”ç”¨ (Package app)

- æ–¹æ³•ä¸€

```
# è¿›å…¥æ¡Œé¢ï¼Œç¡®ä¿å½“å‰åœ¨æ¡Œé¢ä¸Šæ“ä½œ
# cd ~/Desktop/

zip -r WeChat_705_New.ipa Payload/

# é™é»˜å‹ç¼©
# zip -qr WeChat_705_New.ipa Payload/
```

- æ–¹æ³•äºŒ

**PackageApplication** ä¸»è¦ç”¨æ¥é€šè¿‡è„šæœ¬æ‰“åŒ… ipa æ–‡ä»¶ï¼Œç„¶è€Œä» **Xcode 8.2.1** ç‰ˆæœ¬ä¹‹åï¼Œå°±ä¸å»ºè®®ä½¿ç”¨äº†ã€‚æ‰€ä»¥æ¯æ¬¡æ›´æ–° Xcode ç‰ˆæœ¬ï¼Œéƒ½è¦æ‰‹åŠ¨æ·»åŠ  **PackageApplication** ã€‚

**PackageApplication** ä¸‹è½½åœ°å€ï¼š

1. ç™¾åº¦ç½‘ç›˜ä¸‹è½½ï¼š

[https://pan.baidu.com/s/1AjVW8hWYlVz3Cu9UJByQOQ - æå–ç ï¼š4sqb](https://pan.baidu.com/s/1AjVW8hWYlVz3Cu9UJByQOQ)

2. Githubä¸‹è½½ï¼š

[https://github.com/dgynfi/WeChat_tweak/tree/master/Hook-Tools/](https://github.com/dgynfi/WeChat_tweak/tree/master/Hook-Tools/)

å°†ä¸‹è½½çš„ **PackageApplication** æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¹¶è®¾ç½®å¯æ‰§è¡Œæƒé™ï¼š

```
chmod 777 ~/Downloads/PackageApplication
```

Applications -> å³é”® Xcode.app -> æ˜¾ç¤ºåŒ…å†…å®¹ -> Contents -> Developer -> platforms -> iPhoneOS.platform -> Developer -> usr -> binï¼Œè¿›å…¥è¿™ä¸ªç›®å½•ä¹‹åï¼Œå°†è®¾ç½®äº†å¯æ‰§è¡Œæƒé™çš„ **PackageApplication** å¤åˆ¶åˆ°è¿™ä¸ªç›®å½•ã€‚

æˆ–è€…ä½¿ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š

```
cp ~/Downloads/PackageApplication /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin
```

æ‰§è¡Œæ‰“åŒ…ï¼š

```
xcrun -sdk iphoneos PackageApplication -v Payload/WeChat.app -o ~/Desktop/WeChat_705_New.ipa
```

### å®‰è£… ipa 

1. æœ€åä½¿ç”¨ **çˆ±æ€åŠ©æ‰‹/ifunbox** å®‰è£… WeChat_705_New.ipa ã€‚

2. ä½¿ç”¨ Xcode -> Window -> Devices and Simulators ï¼Œå³å‡»è‡ªå·±çš„è®¾å¤‡ï¼Œé€‰æ‹© Connect via IP Adress...ï¼Œè¾“å…¥è®¾å¤‡çš„IPï¼Œç„¶åç‚¹å‡» Connect ï¼Œæœ€ååœ¨ INSTALLED APPS å¤„ç‚¹å‡» â€œ+â€ å·ï¼Œç„¶åé€‰æ‹© WeChat_705_New.ipa ï¼Œç‚¹å‡» Open ï¼Œç„¶åæ¼«é•¿åœ°ç­‰å¾…å®‰è£…ï¼Œå¤§çº¦1 ~ 3åˆ†é’Ÿã€‚

## ğŸ’°æ”¯æŒä½œè€…

å¦‚æœè§‰å¾—è¿™ä¸ªæ’ä»¶å¯¹ä½ æœ‰å¸®åŠ© (å¸®ä½ æŠ¢åˆ°äº†æ¯”ä¹‹å‰æ›´å¤šçš„çº¢åŒ…ï¼Œå¸®ä½ å‘åœ¨å›½å¤–é«˜å¤§å°šçš„æœ‹å‹åœˆï¼Œå¸®ä½ å±è”½äº†åŒçƒ¦å¹¶å¨æ‰°çš„äººå’Œç¾¤ï¼Œå¸®ä½ ä¸å†é”™è¿‡ä»»ä½•æ¶ˆæ¯ï¼Œ...) ï¼Œé‚£ä¹ˆä¸å¦¨è¯·æˆ‘å–æ¯å’–å•¡â˜•ã€‚

<div align=left>
&emsp; <img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/alipay_paymentcode.jpg" width="30%" />&nbsp; 
<img src="https://github.com/dgynfi/WeChat_tweak/raw/master/images/wechat_apprcode.jpg" width="30%" />
</div>

## Hook ç‰ˆæœ¬ä¸‹è½½

Hook çš„ç‰ˆæœ¬åªéœ€è¦æŒ‰ç…§è§£å‹ ipa (Unzip ipa)ï¼Œé‡ç­¾ååº”ç”¨ (Resign app) ï¼Œæ‰“åŒ…åº”ç”¨ (Package app) ï¼Œå®‰è£… ipa ç­‰æ­¥éª¤æ‰§è¡Œå³å¯ã€‚

- ç™¾åº¦ç½‘ç›˜ä¸‹è½½ï¼š

[https://pan.baidu.com/s/1KCwmMWzchaZDeZQSlNt6qg - æå–ç ï¼š3eqb](https://pan.baidu.com/s/1KCwmMWzchaZDeZQSlNt6qg)

## åæ ‡æ‹¾å–

- [ç™¾åº¦åœ°å›¾-æ‹¾å–åæ ‡ç³»ç»Ÿ](http://api.map.baidu.com/lbsapi/getpoint/index.html)
- [é«˜å¾·åœ°å›¾-åæ ‡æ‹¾å–å™¨](https://lbs.amap.com/console/show/picker)
- [è…¾è®¯åœ°å›¾-åæ ‡æ‹¾å–å™¨](https://lbs.qq.com/tool/getpoint/index.html)

æ¸…åå¤§å­¦ï¼š116.333446,40.009557

## å…è´¹è¯ä¹¦

- [iOSä¸ªäººè¯ä¹¦çœŸæœºè°ƒè¯•åŠæŠ¥é”™](https://www.jianshu.com/p/f31116a76ea9)
- [iOS Xcode8å…è¯ä¹¦çœŸæœºè°ƒè¯•ï¼ˆä¸è¶Šç‹±ï¼‰](https://www.jianshu.com/p/5c1fb2cb293c)
- [IOSå¼€å‘ä¹‹å…è´¹è¯ä¹¦+ä¸è¶Šç‹±çœŸæœºè°ƒè¯•](https://www.cnblogs.com/iOS-mt/p/5454287.html)

å…è´¹è¯ä¹¦èƒ½è¿›è¡ŒçœŸæœºè°ƒè¯•ç¨‹åºã€‚æ–°å»ºä¸€ä¸ªæ¨¡æ¿å·¥ç¨‹ï¼Œé€šè¿‡ Xcode ç™»å…¥è‡ªå·±çš„ Apple ID (èœå• Xcode -> Preferences... -> Accounts -> ç‚¹å‡» + -> é€‰æ‹© Apple ID -> è¾“å…¥è´¦å·å¯†ç  -> ç™»å…¥)ï¼Œè¿›å…¥ TARGETS -> General -> Identify -> è®¾ç½® Bundle Identifier ï¼Œæ–° Xcode ç‰ˆæœ¬è¿›å…¥ Signing & Capabilities -> å‹¾é€‰è‡ªåŠ¨ç®¡ç†ç­¾å (Automatically manage signing)ï¼Œæ—§ç‰ˆæœ¬ç›´æ¥å‹¾é€‰è‡ªåŠ¨ç®¡ç†ç­¾å (Automatically manage signing) å³å¯ï¼Œç­‰å¾…è‡ªåŠ¨ç”Ÿæˆ Provisioning Profile å’Œ Signing Certificate åï¼Œå¯æŸ¥çœ‹ App ID, Team ç­‰ä¿¡æ¯ï¼Œä½†å…è´¹è¯ä¹¦æœ‰ä¸ªç¼ºç‚¹ ï¼Œå…¶ä¸­ Provisioning Profile (xxx.mobileprovision) æ–‡ä»¶æœ‰æ•ˆæœŸä»…åªæœ‰ **7** å¤©ï¼Œè¿‡æœŸåéœ€è¦æ‰“å¼€ Xcode æ¨¡æ¿å·¥ç¨‹é‡æ–°ç”Ÿæˆã€‚æˆ‘ä»¬åœ¨å­¦ä¹ æ—¶å¯ä»¥åˆ©ç”¨å…è´¹è¯ä¹¦çœŸæœºè°ƒè¯•ç¨‹åºå’Œé‡ç­¾ååº”ç”¨ (Resign app) ï¼Œä½†æ˜¯é•¿æœŸä½¿ç”¨ï¼Œä¸å»ºè®®ä½¿ç”¨å…è´¹è¯ä¹¦ï¼Œæ¨èå¯ä»¥å»è‹¹æœå¼€å‘è€…åå°ç”³è¯· Apple ID è´¦å·æˆ–è€…å»æŸå®æ‰¾å•†å®¶ä»£ç­¾å (é£é™©éœ€è¦è‡ªå·±æ‰¿æ‹…)ã€‚

## å»ºè®®

å¦‚æœæ‚¨è¦å°†åŠ¨æ€åº“ **wapleodtcorexpc** å’Œ **waplesubstrate** ä¿®æ”¹æˆè‡ªå®šä¹‰çš„åå­—ï¼Œé‚£ä¹ˆåªè¦å°† **wapleodtcorexpc** å·¥ç¨‹åå’Œ **Makefileã€controlã€xxx.plist** æ–‡ä»¶å†…çš„éƒ¨åˆ†ä¿¡æ¯ä¸€å¹¶ä¿®æ”¹ï¼Œç„¶åä»æ­¥éª¤ **ç¼–è¯‘ tweak é¡¹ç›® (Compile Tweak Project)** é‡æ–°å¼€å§‹æ“ä½œã€‚

## ç®€ä¹¦

- [iOSé€†å‘ - å®ç°å¾®ä¿¡è‡ªåŠ¨æŠ¢çº¢åŒ…-ä¼ªå®šä½-é˜²æ’¤å›æ¶ˆæ¯ (éè¶Šç‹±)](https://www.jianshu.com/p/8fa5f61af3e4)

## å‚è€ƒæ–‡ç« 

- [ç§»åŠ¨Appå…¥ä¾µä¸é€†å‘ç ´è§£æŠ€æœ¯ï¼iOSç¯‡](https://mp.weixin.qq.com/s?__biz=MzA3NTYzODYzMg==&mid=2653577384&idx=1&sn=b44a9c9651bf09c5bea7e0337031c53c&scene=0#wechat_redirect)

- [è’¸ç±³çš„æ–‡ç«  - iOSå†°ä¸ç«ä¹‹æ­Œç³»åˆ—](https://github.com/zhengmin1989/MyArticles)

- [iOSå¾®ä¿¡æŠ¢çº¢åŒ…Tweakå®‰è£…æ•™ç¨‹](http://www.swiftyper.com/2016/01/25/ios-tweak-install-guide)

- [ä¸€æ­¥ä¸€æ­¥å®ç°iOSå¾®ä¿¡è‡ªåŠ¨æŠ¢çº¢åŒ…(éè¶Šç‹±)](https://www.jianshu.com/p/189afbe3b429)

- [iOSåº”ç”¨é€†å‘å·¥ç¨‹(ç¬¬2ç‰ˆ)](https://www.amazon.cn/gp/product/B00VFDVY7E/ref=as_li_tf_tl?ie=UTF8&camp=536&creative=3200&creativeASIN=B00VFDVY7E&linkCode=as2&tag=buginux-23)

## iOSé€†å‘äº¤æµ

- [iOSé€†å‘äº¤æµç¤¾åŒº -  iOSRE](http://bbs.iosre.com)

## æ¬¢è¿åé¦ˆ

å¦‚æœä½ æ³¨æ„åˆ°ä»»ä½•é—®é¢˜ï¼Œè¢«å¡ä½æˆ–åªæ˜¯æƒ³èŠå¤©ï¼Œè¯·éšæ„åˆ›å»ºä¸€ä¸ªé—®é¢˜ã€‚æˆ‘å¾ˆä¹æ„å¸®åŠ©ä½ ã€‚
